#!/bin/sh
# Pre-commit hook: block main branch, auto-format and lint

# Prevent commits directly to the main branch
branch="$(git symbolic-ref --short HEAD 2>/dev/null)"

if [ "$branch" = "main" ]; then
    echo "Error: Direct commits to 'main' are not allowed."
    echo "Please create a feature branch and worktree:"
    echo ""
    echo "  git branch my-feature"
    echo "  git worktree add .worktrees/my-feature my-feature"
    echo "  cd .worktrees/my-feature"
    echo "  git config core.hooksPath .githooks"
    echo ""
    exit 1
fi

# Capture originally staged files before formatting
staged_files="$(git diff --cached --name-only --diff-filter=AM)"

# Auto-format with cargo fmt
cargo fmt

# Re-stage only originally staged files that were modified by fmt
printf '%s\n' "$staged_files" | while IFS= read -r file; do
    if [ -n "$file" ] && git diff --name-only -- "$file" | grep -q .; then
        git add "$file"
    fi
done

# Run clippy (deny warnings)
if ! cargo clippy --all-targets -- -D warnings; then
    echo "error: cargo clippy found warnings. Fix them and retry."
    exit 1
fi
